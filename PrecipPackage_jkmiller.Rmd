---
title: "ESM 262 - Assignment 5"
author: "Jamie Miller"
date: "June 7, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(devtools)
library(testthat)
library(roxygen2)
```

The goal of this assignment is to create a package that will be used for assessing climate change impacts and developing mitiation and adaptation strategies

(the goal here is to practice some coding skills so that routines and data may be provisional)

Here’s what the package should contain

- at least two different functions that summarize climate data in some way (your choice - it could be finding a trend, or finding extremes; or even simply mean winter precipitation)
- at least two functions that calculate some measure of impact (you can really make these us) 
     -so for example you could create a function that computes a heat stress index based on air temperature with parameters that vary with for different species; or a function that estimates water supply from precipitation with parameters that vary to reflect water storage …you can make something up just as long as its somewhat sensible
- one function that estimates the costs of impacts
- use multi-dimensional arrays in one of your functions


The package should contain:
- some sample data
- documentation for ALL functions
- a vignette that shows how to use several of the functions with the sample data
- 3 separate tests - (next weeks lecture)


## Package structure
Summarizing functions
- Mean precipitation by season and by year
-
Measure of impact functions
-
- Predict location and month with highest risk of floods in a year
Tests
- For mean precip: months = 12? seasons = 4?
- For predict flooding: is numeric? is precip always positive?
-

```{r}
# First, find some data.

# Source: Monthly Observed Precipitation - NWS Cooperative Observers. The following are data from NWS cooperative observers for the current water year and historically back to Water Year 2002. The water year starts on Oct 1 and ends on Sept 30. Precipitation data is provided for each month of the current water year, total precipitation for the water year, the percent of normal for the water year to date, and the percent of the entire water year received to date. https://www.cnrfc.noaa.gov/rainfall_data.php#monthly

# From each Monthly Precipitation Summary for every water year 2002-2019, The monthly rainfall values for Paso Robles, San Luis Obispo, and Santa Barbara were copy/pasted into a csv file. 
# WY to Date, Pct Avg to Date and Pct Tot WY columns were deleted. 
# extraneous rows not of these three locations were deleted.
# Doubt the column will be used, but ID was standardized such that PRB = PASO ROBLES, SBP = SAN LUIS OBISPO, and SBA = SANTA BARBARA.
# Cells with a values of M for Missing Data were changed to NA.
# Empty cells were left empty.
# The water year starts on October 1 and ends on September 30. 
# precipitation measured in inches

### Read in Data
slo_climate_data <- read_csv("slo_climate_data.csv")

monthly_precip <- gather(slo_climate_data, 
                 key = "month", 
                 value = "precip", "OCT","NOV","DEC","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP") %>% 
  filter(!is.na(precip))
```

```{r}
### Store the data in data subdirectory of your package
# use_data_raw() for scripts that generate data
# use_data() to save package data in correct format
```

```{r}
# usethis::use_test()
```





```{r}
# for kicks, create a reservoir dataframe

reservoir <- data.frame(ID = c("PRB", "SBP", "SBA"),
                        reservoir = c("Whale Rock","Cachuma","Gibraltar"),
                        res_tot_cap = c(40662, 193305, 4314), # units are scre feet (can convert to )
                        res_fill = c(40662*.50, 193305*.50, 4314*.50) # start out each reservoir at 50% capacity in Oct of water year 2002
                        )

# can use this data frame to calculate influx of rain water to each reservoir, assuming each reservoir was at 50% capacity starting in October of water year 2002. 
# a test we can use for this is when the reservoir reaches capacity, overflowing and no longer collecting water for use.
# could be function that converts units of rainfall; units of watershed, and units of reservoir capacity
# probably easier to just do conversrions in data frame and the use functions to calculate influx

```





```{r}
# start with something easy. 
# calculate the total water year precipitation.

wy_tot <- function(x) {
  sum(monthly_precip$precip)
}

wy_tot() # 829.49 is correct

##################

# calculate the mean monthly precipitation.
wy_ave <- function(x) {
  ave(monthly_precip$precip)
}

wy_ave() # this gave me 632 values of 1.312484, which is correct, but why 632 of them?

##################

# calculate the total water year precipitation for a given month.

wy_tot_mo <- function(x) {
  sum(precip)

}

wy_tot_mo() 

# Making a change!

```


```{r}
source("R/mean_precip_by_season.R")
# To see how this function works you can change the year and use the same precipitation data
mean_precip_by_season(monthly_precip, 2014)
```

```{r}
source("R/predict_flooding.R")
# To see how this function works you can change the year and use the same precipitation data
predict_flooding(monthly_precip, 2007)
```

```{r}
# Sum of precipitation for each location by water year


wy_tot <- monthly_precip %>%
    group_by(Location, water_year) %>% 
    summarize(sum_precip = sum(precip)) #%>%
#    ungroup()
wy_tot

wy_tot_plot <- ggplot(wy_tot, aes(x = water_year, y = sum_precip)) +
  geom_col(aes(fill = Location)) +
  labs(x = "Water Year", y = "Total Precipitation (inches)") +
  theme_bw()

wy_tot_plot

wy_tot_table <- wy_tot %>% 
  rename("Water Year" = water_year) %>% 
  spread(wy_tot, key = Location, value = sum_precip) %>% 
  knitr::kable()

wy_tot_table

```

```{r}


total_precip_by_year <- function(precip_data, plot = FALSE) {

  wy_tot <- precip_data %>%
    group_by(Location, water_year) %>% 
    summarize(sum_precip = sum(precip)) %>%
    ungroup()
  
  if(plot == TRUE) {
    
    wy_tot_plot <- ggplot(wy_tot, aes(x = water_year, y = sum_precip)) +
      geom_col(aes(fill = Location)) +
      labs(x = "Water Year", y = "Total Precipitation (inches)") +
      theme_bw()
    print(wy_tot_plot)      
  }
  
  if(plot == FALSE) {
    
    wy_tot_table <- wy_tot %>% 
      rename("Water Year" = water_year) %>% 
      spread(wy_tot, key = Location, value = sum_precip) %>% 
      knitr::kable()
    
  }

#  wy_tot_output <- list('wy_tot' = wy_tot, 'wy_tot_plot' = wy_tot_plot)
  
  return(wy_tot_table)
  

}


```

```{r}
source("R/total_precip_by_year.R")
# This function calculates annual precipitation totals for each water year by location. displayed as either a graph (TRUE) or a table (FALSE).
total_precip_by_year(monthly_precip, TRUE)

```

```{r}
# Take monthly_precip dataframe, turn into a multidimensional array, find mean precipitation either by month, location, or water year, or all.

Location <- c("Paso Robles", "San Luis Obispo", "Santa Barbara")
Month <- c("Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep")

precip_array <- array(data = monthly_precip$precip,
                      dim = c(18,3,12),
                      dimnames = list(2002:2019, # water year labels
                                      Location,
                                      Month))

# Average monthly precipitation for all years
precip_month_mean <- apply(precip_array, MARGIN = 3, FUN = mean)

# Average precipitation for each location for all years
precip_location_mean <- apply(precip_array, MARGIN = 2, FUN = mean)

# Total precipitation for each location for all years
precip_loc_total <- apply(precip_array, MARGIN = 2, FUN = sum)

```


```{r}
# check answer for multidimenional array functions

precip_month_mean_df <- monthly_precip %>% 
  group_by(month) %>% 
  summarize(ave_month_precip = mean(precip))

precip_month_mean_df

# THEY MATCH!

precip_loc_mean_df <- monthly_precip %>% 
  group_by(Location) %>% 
  summarize(ave_month_precip = mean(precip))

precip_loc_mean_df
# They don't quite match, but are close. This could have to do with WY 2019 being only half a year.

precip_loc_total_df <- monthly_precip %>% 
  group_by(Location) %>% 
  summarize(sum_month_precip = sum(precip))

precip_loc_total_df
# They don't quite match, but are close. This could have to do with WY 2019 being only half a year.

```

```{r}
source("R/mean_precip_by_month.R")
# This function calculates annual precipitation totals for each water year by location. displayed as either a graph (TRUE) or a table (FALSE).
mean_precip_by_month(precip_array)

```


